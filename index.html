<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Jobs</title>
    <style>
        .timestamp {
            color: darkgreen;
        }
        .chat-button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #25D366;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .chat-button:hover {
            background-color: #128C7E;
        }
        .map {
            height: 300px;
            width: 100%;
            margin-top: 10px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBePghG20-wfUWPBV72MH_s6fUe-Z4N7Jo&callback=initMap" async defer></script>
</head>
<body>
    <h1 id="page-title">Available Jobs as at <span class="timestamp" id="current-datetime"></span></h1>
    <div id="jobs-list"></div>

    <script>
        // Function to format the date as DD/MM/YYYY
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Function to update the heading with the current date and time
        function updateDateTime() {
            const now = new Date();
            const formattedDate = formatDate(now);
            const formattedTime = now.toLocaleTimeString();
            document.getElementById('current-datetime').textContent = `${formattedDate}, ${formattedTime}`;
        }

        // Function to fetch and display jobs from Gist
        async function fetchGistData() {
            const gistId = '9526ff124bc34bccf81664398b668a8a'; // Jobs Gist
            const url = `https://api.github.com/gists/${gistId}`;
            
            // Fetch the job groups and hourly rates from the Gist
            const jobGroupsGistId = '3ee629f23be937756d7430ed4c646423'; // Your jobgroups.json Gist ID
            const jobGroupsUrl = `https://api.github.com/gists/${jobGroupsGistId}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                const jobDetails = JSON.parse(data.files['available_jobs.json'].content);

                // Fetch job group rates
                const jobGroupsResponse = await fetch(jobGroupsUrl);
                const jobGroupsData = await jobGroupsResponse.json();
                const jobGroups = JSON.parse(jobGroupsData.files['jobgroups.json'].content);

                // Display the job details
                let jobListHtml = '<ul>';
                jobDetails.forEach((job, index) => {
                    const timePosted = new Date(job.timestamp);
                    const formattedTimestamp = formatDate(timePosted) + ', ' + timePosted.toLocaleTimeString();
                    const phoneInternational = job.phone.replace(/^0/, '254');

                    // Get the hourly rate based on the job group
                    const hourlyRate = jobGroups[job.job_group] || 0; // If no matching job group, default to 0
                    const totalPayment = hourlyRate * job.expected_hours;

                    jobListHtml += `<li>
                        <strong>Job Title:</strong> ${job.job_title}<br>
                        <strong>Job Description:</strong> ${job.job_description}<br>
                        <strong>Expected Hours:</strong> ${job.expected_hours}<br>
                        <strong>Total Payment:</strong> ${totalPayment.toFixed(2)}<br> <!-- Display Total Payment -->
                        <strong>City:</strong> ${job.city}<br>
                        <strong>Town:</strong> ${job.town}<br>
                        <strong>Street:</strong> ${job.street}<br>
                        <strong>Estate/Building Name:</strong> ${job.estate_or_building_name}<br>
                        <strong>Contact:</strong> ${job.phone}<br>
                        <strong>Time Posted:</strong> ${formattedTimestamp}<br>
                        <button class="chat-button" onclick="window.open('https://wa.me/${phoneInternational}', '_blank')">Chat Now</button>
                        <div class="map" id="map-${index}"></div> <!-- Unique ID for each map -->
                    </li><hr>`;
                });
                jobListHtml += '</ul>';
                document.getElementById('jobs-list').innerHTML = jobListHtml;

                // Initialize maps after the job list is displayed
                jobDetails.forEach((job, index) => {
                    if (job.latitude && job.longitude) {
                        initMap(job.latitude, job.longitude, index);
                    } else {
                        console.error(`Missing latitude/longitude for job: ${job.job_title}`);
                    }
                });

            } catch (error) {
                console.error('Error fetching Gist data:', error);
            }
        }

        // Function to check authorization
        async function checkAuthorization() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');

            if (!email) {
                window.location.href = 'https://shertonholdings.github.io/availableopportunities/';
                return;
            }

            const gistId = 'bebbb55c9f86cb1180a5ed7aaa64fce4';
            const gistUrl = `https://api.github.com/gists/${gistId}`;

            try {
                const response = await fetch(gistUrl);
                const data = await response.json();

                const content = JSON.parse(data.files['user_data.json'].content);
                const user = content.find(user => user.email === email);

                if (!user) {
                    window.location.href = 'https://shertonholdings.github.io/availableopportunities/';
                } else {
                    console.log(`Authorized: ${user.first_name} ${user.last_name}`);
                    updateDateTime();
                    fetchGistData();
                }
            } catch (error) {
                console.error('Error checking authorization:', error);
                window.location.href = 'https://shertonholdings.github.io/availableopportunities/';
            }
        }

        // Function to initialize the map for each job
        function initMap(latitude, longitude, index) {
            const location = { lat: parseFloat(latitude), lng: parseFloat(longitude) }; // Ensure lat/lng are numbers
            const map = new google.maps.Map(document.getElementById(`map-${index}`), {
                zoom: 15,
                center: location,
            });
            new google.maps.Marker({
                position: location,
                map: map,
            });
        }

        // Check authorization on page load
        checkAuthorization();
    </script>
</body>
</html>
